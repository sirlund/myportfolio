---
interface Props {
  title: string;
  subtitle: string;
  cta: string;
}

const { title, subtitle, cta } = Astro.props;
---

<section id="home" class="hero-section">
  <!-- Three.js Canvas Container -->
  <div id="bubble-container" class="canvas-container">
    <!-- Loader placeholder while Three.js loads -->
    <div class="canvas-loader">
      <div class="loader-bubble"></div>
    </div>
  </div>

  <!-- Content -->
  <div class="content-wrapper">
    <div class="content-center">
      <div class="content">
        <div class="animate-fade-up" style="--delay: 0.2s">
          <h1 class="title">{title}</h1>
        </div>

        <div class="animate-fade-up" style="--delay: 0.4s">
          <p class="description">{subtitle}</p>
        </div>

        <div class="animate-fade-up" style="--delay: 0.6s">
          <a href="#work" class="cta-link">
            {cta}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M7 17L17 7M17 7H7M17 7V17"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Scroll Indicator -->
  <div class="scroll-indicator animate-fade-in" style="--delay: 1.2s">
    <div class="scroll-mouse">
      <svg width="20" height="32" viewBox="0 0 20 32" fill="none">
        <rect x="1" y="1" width="18" height="26" rx="9" stroke="currentColor" stroke-width="1.5" fill="none"/>
        <rect class="scroll-wheel" x="8.5" y="6" width="3" height="6" rx="1.5" fill="currentColor"/>
      </svg>
    </div>
  </div>
</section>

<script>
  // Dynamic import - Three.js only loads when this component is used
  let cleanup: (() => void) | null = null;
  let threeModule: typeof import('@/scripts/three-bubble') | null = null;

  async function init() {
    // Cleanup previous instance if exists
    if (cleanup) {
      cleanup();
      cleanup = null;
    }

    const container = document.getElementById('bubble-container');
    if (!container) return;

    // Check if module is already cached (instant load)
    const isAlreadyCached = !!threeModule;

    // If cached, skip loader animation
    if (isAlreadyCached) {
      container.classList.add('loaded');
    } else {
      container.classList.remove('loaded');
    }

    // Lazy load Three.js bundle only when needed
    if (!threeModule) {
      threeModule = await import('@/scripts/three-bubble');
    }

    // Remove any existing canvas
    const existingCanvas = container.querySelector('canvas');
    if (existingCanvas) existingCanvas.remove();

    // Initialize Three.js
    cleanup = threeModule.initBubble(container);

    // Trigger transition after canvas is ready (only if wasn't cached)
    if (!isAlreadyCached) {
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          container.classList.add('loaded');
        });
      });
    }
  }

  // Initialize on page load
  init();

  // Re-initialize on View Transitions navigation
  document.addEventListener('astro:page-load', init);

  // Cleanup on page swap (View Transitions)
  document.addEventListener('astro:before-swap', () => {
    if (cleanup) {
      cleanup();
      cleanup = null;
    }
  });
</script>

<style>
  /* ============================================
     Hero Section
     ============================================ */
  .hero-section {
    min-height: 100vh;
    position: relative;
    overflow: hidden;
  }

  /* ============================================
     Canvas Container
     ============================================ */
  .canvas-container {
    position: absolute;
    inset: 0;
    z-index: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #fafafa;
    pointer-events: none;
  }

  .canvas-container :global(canvas) {
    display: block;
    opacity: 0;
    transform: scale(0.5);
    transition: opacity 1.4s ease-out, transform 1.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .canvas-container.loaded :global(canvas) {
    opacity: 1;
    transform: scale(1);
  }

  /* Loader placeholder */
  .canvas-loader {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 1.2s ease-out, transform 1.2s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .canvas-container.loaded .canvas-loader {
    opacity: 0;
    transform: scale(0.3);
    pointer-events: none;
  }

  .loader-bubble {
    width: min(35vw, 250px);
    height: min(35vw, 250px);
    border-radius: 50%;
    background: radial-gradient(
      circle at 30% 30%,
      rgba(180, 160, 200, 0.4) 0%,
      rgba(140, 180, 200, 0.3) 40%,
      rgba(200, 180, 220, 0.2) 70%,
      transparent 100%
    );
    animation: loaderPulse 2s ease-in-out infinite;
  }

  @keyframes loaderPulse {
    0%, 100% {
      transform: scale(0.95);
      opacity: 0.6;
    }
    50% {
      transform: scale(1.05);
      opacity: 0.9;
    }
  }

  /* ============================================
     Content Wrapper
     ============================================ */
  .content-wrapper {
    position: relative;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: var(--space-4);
    pointer-events: none;
  }

  @media (width >= 40rem) {
    .content-wrapper {
      padding: var(--space-6);
    }
  }

  @media (width >= 48rem) {
    .content-wrapper {
      padding: var(--space-8);
    }
  }

  @media (width >= 64rem) {
    .content-wrapper {
      padding: var(--space-12);
    }
  }

  .content-center {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: var(--container-4xl, 56rem);
  }

  .content {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    text-align: center;
  }

  @media (width >= 40rem) {
    .content {
      gap: var(--space-6);
      padding: var(--space-6);
    }
  }

  @media (width >= 48rem) {
    .content {
      gap: var(--space-8);
      padding: var(--space-8);
    }
  }

  /* ============================================
     Typography
     ============================================ */
  .title {
    font-size: var(--font-display);
    font-weight: var(--font-weight-bold);
    line-height: 1.1;
    margin-bottom: var(--space-2);
  }

  @media (width >= 40rem) {
    .title {
      margin-bottom: var(--space-3);
    }
  }

  @media (width >= 64rem) {
    .title {
      margin-bottom: var(--space-4);
    }
  }

  .description {
    font-size: var(--font-lg);
    color: var(--color-text-secondary);
    max-width: var(--container-2xl, 42rem);
    margin: 0 auto var(--space-4);
    padding: 0 var(--space-2);
    line-height: 1.6;
  }

  @media (width >= 40rem) {
    .description {
      margin-bottom: var(--space-6);
      padding: 0;
    }
  }

  @media (width >= 64rem) {
    .description {
      margin-bottom: var(--space-8);
    }
  }

  /* ============================================
     CTA Link
     ============================================ */
  .cta-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--font-body);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
    text-decoration: none;
    padding: var(--space-2) 0;
    border-bottom: 1px solid currentColor;
    transition: all var(--duration-fast) ease;
    pointer-events: auto;
  }

  .cta-link:hover {
    color: var(--color-interactive-primary);
    gap: var(--space-3);
  }

  .cta-link svg {
    transition: transform var(--duration-fast) ease;
  }

  .cta-link:hover svg {
    transform: translate(2px, -2px);
  }

  /* ============================================
     Scroll Indicator
     ============================================ */
  .scroll-indicator {
    position: absolute;
    bottom: var(--space-6);
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }

  @media (width >= 40rem) {
    .scroll-indicator {
      bottom: var(--space-8);
    }
  }

  .scroll-mouse {
    color: var(--color-text-secondary);
    animation: bounce 2s infinite ease-in-out;
  }

  .scroll-wheel {
    animation: pulse 2s infinite ease-in-out;
  }

  /* ============================================
     Animations
     ============================================ */
  @keyframes bounce {
    0%, 100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(4px);
    }
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 0.4;
    }
    50% {
      opacity: 1;
    }
  }

  .animate-fade-up {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeUp 0.8s ease forwards;
    animation-delay: var(--delay, 0s);
  }

  .animate-fade-in {
    opacity: 0;
    animation: fadeIn 1s ease forwards;
    animation-delay: var(--delay, 0s);
  }

  @keyframes fadeUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }
</style>
