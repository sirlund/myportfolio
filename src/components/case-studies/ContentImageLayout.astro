---
/**
 * ContentImageLayout Component
 *
 * Two modes of operation:
 * 1. Simple Grid (default): Direct images as children, placed in CSS grid
 * 2. Column Layout (columnLayout=true): Uses Column components as children
 *
 * For columnLayout mode with automatic proportions, calculate columnWidths as:
 * columnWidths = columns.map(c => (c.naturalWidth / c.naturalHeight).toFixed(4) + 'fr').join(' ')
 */
interface Props {
  columns?: 2 | 3 | 4;
  columnWidths?: string;
  gap?: 'default' | 'none' | 'compact';
  stretch?: boolean;
  columnLayout?: boolean;
  caption?: string;
  backgroundColor?: string;
  class?: string;
  style?: string;
}

const {
  columns = 2,
  columnWidths,
  gap = 'default',
  stretch = true,
  columnLayout = false,
  caption,
  backgroundColor,
  class: className = '',
  style: customStyle = ''
} = Astro.props;

// Default column widths based on column count
const defaultColumns = Array(columns).fill('1fr').join(' ');
const customColumns = columnWidths || defaultColumns;

// Build inline style
const styleString = [
  `--custom-columns: ${customColumns}`,
  backgroundColor ? `background-color: ${backgroundColor}` : '',
  customStyle
].filter(Boolean).join('; ');
---

<div
  class:list={[
    columnLayout ? 'column-layout' : 'layout',
    !columnLayout && `cols-${columns}`,
    `gap-${gap}`,
    stretch ? 'stretch' : 'no-stretch',
    className
  ]}
  style={styleString}
>
  <slot />
  {caption && <div class="caption">{caption}</div>}
</div>

<style>
  /* ============================================
     Base Layout (Simple Grid Mode)
     ============================================ */
  .layout {
    display: grid;
    grid-template-columns: 1fr;
    margin-top: var(--space-12);
  }

  @media (width >= 64rem) {
    .layout {
      margin-top: var(--space-16);
    }
  }

  /* Alignment */
  .stretch {
    align-items: stretch;
  }

  .no-stretch {
    align-items: start;
  }

  /* Column variants */
  .cols-2 {
    @media (width >= 64rem) {
      grid-template-columns: var(--custom-columns, 1fr 1fr);
    }
  }

  .cols-3 {
    @media (width >= 48rem) {
      grid-template-columns: 1fr 1fr;
    }
    @media (width >= 64rem) {
      grid-template-columns: var(--custom-columns, 1fr 1fr 1fr);
    }
  }

  .cols-4 {
    @media (width >= 48rem) {
      grid-template-columns: 1fr 1fr;
    }
    @media (width >= 64rem) {
      grid-template-columns: var(--custom-columns, 1fr 1fr 1fr 1fr);
    }
  }

  /* Gap variants */
  .gap-default {
    gap: var(--space-6);
  }

  @media (width >= 64rem) {
    .gap-default {
      gap: var(--space-8);
    }
  }

  .gap-compact {
    gap: var(--space-3);
  }

  @media (width >= 64rem) {
    .gap-compact {
      gap: var(--space-4);
    }
  }

  .gap-none {
    gap: 0;
  }

  /* When gap is none, remove border-radius for seamless grid */
  .gap-none :global(img) {
    border-radius: 0;
  }

  /* ============================================
     Column Layout Mode
     ============================================ */
  .column-layout {
    display: grid;
    grid-template-columns: var(--custom-columns, 1fr);
    margin-top: var(--space-12);
  }

  /* Mobile: stack columns vertically */
  @media (width < 48rem) {
    .column-layout {
      grid-template-columns: 1fr;
    }
  }

  @media (width >= 64rem) {
    .column-layout {
      margin-top: var(--space-16);
    }
  }

  /* ============================================
     Caption
     ============================================ */
  .caption {
    margin-top: var(--space-4);
    font-size: var(--font-caption, var(--text-sm));
    color: var(--color-text-secondary);
    text-align: center;
    font-style: normal;
    width: 100%;
    grid-column: 1 / -1;
  }
</style>
