---
/**
 * Image Component
 * Renders a simple <img> by default, wraps in <figure> only when caption is provided
 *
 * Placeholder variants:
 * - "default": Icon + label on dashed border background (for asset planning)
 * - "fallback": Subtle failed-to-load style with just label text (for production placeholders)
 */
interface Props {
  src?: string;
  alt: string;
  aspectRatio?: string;
  objectFit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';
  caption?: string;
  label?: string;
  placeholder?: 'default' | 'fallback';
  noMargin?: boolean;
  class?: string;
  style?: string;
}

const {
  src,
  alt,
  aspectRatio,
  objectFit = 'cover',
  caption,
  label,
  placeholder = 'default',
  noMargin = false,
  class: className = '',
  style: customStyle = ''
} = Astro.props;

const isPlaceholder = !src;

// Build inline style for img
const imgStyle = [
  aspectRatio ? `aspect-ratio: ${aspectRatio}` : '',
  `object-fit: ${objectFit}`,
  customStyle
].filter(Boolean).join('; ');

const placeholderStyle = aspectRatio ? `aspect-ratio: ${aspectRatio}` : '';
---

{isPlaceholder && placeholder === 'fallback' ? (
  <!-- Fallback placeholder: subtle failed-to-load style -->
  <div class:list={['placeholder-fallback', noMargin ? 'no-margin' : '', className]} style={placeholderStyle}>
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      <circle cx="8.5" cy="8.5" r="1.5"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
    {label && <span class="fallback-label">{label}</span>}
  </div>
) : isPlaceholder ? (
  <!-- Default placeholder: icon + label for asset planning -->
  <div class:list={['placeholder', noMargin ? 'no-margin' : '', className]} style={placeholderStyle}>
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      <circle cx="8.5" cy="8.5" r="1.5"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
    {label && <span class="placeholder-label">{label}</span>}
  </div>
) : caption ? (
  <!-- With caption: wrap in figure -->
  <figure class:list={[noMargin ? 'figure-no-margin' : 'figure', className]}>
    <img src={src} alt={alt} loading="lazy" class="image" style={imgStyle} />
    <figcaption class="caption">{caption}</figcaption>
  </figure>
) : (
  <!-- Simple img -->
  <img src={src} alt={alt} loading="lazy" class:list={['image', className]} style={imgStyle} />
)}

<style>
  .image {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius-md);
    margin: 0;
  }

  .figure {
    margin: var(--space-12) 0;
    display: flex;
    flex-direction: column;
  }

  @media (width >= 64rem) {
    .figure {
      margin: var(--space-16) 0;
    }
  }

  .figure > .image {
    flex: 1;
    min-height: 0;
  }

  .figure-no-margin {
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .figure-no-margin > .image {
    flex: 1;
    min-height: 0;
  }

  .caption {
    margin-top: var(--space-3);
    font-size: var(--font-caption, var(--text-sm));
    color: var(--color-text-secondary);
    text-align: center;
    font-style: italic;
  }

  .placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
    background-color: var(--color-bg-tertiary);
    border: 1px dashed var(--color-border-default);
    border-radius: var(--radius-md);
    min-height: 200px;
    margin: var(--space-12) 0;
    color: var(--color-text-tertiary);
  }

  @media (width >= 64rem) {
    .placeholder {
      margin: var(--space-16) 0;
    }
  }

  .placeholder svg {
    opacity: 0.5;
  }

  .placeholder-label {
    font-size: var(--font-caption, var(--text-sm));
    color: var(--color-text-secondary);
    text-align: center;
    padding: var(--space-4);
  }

  /* Fallback placeholder: subtle failed-to-load style */
  .placeholder-fallback {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    min-height: 80px;
    margin: var(--space-12) 0;
    padding: var(--space-4);
    color: var(--color-text-tertiary);
  }

  @media (width >= 64rem) {
    .placeholder-fallback {
      margin: var(--space-16) 0;
    }
  }

  .placeholder-fallback svg {
    opacity: 0.4;
    flex-shrink: 0;
  }

  .fallback-label {
    font-size: var(--font-caption, var(--text-sm));
    color: var(--color-text-tertiary);
    font-style: italic;
  }

  /* No margin override */
  .no-margin {
    margin: 0 !important;
  }
</style>
