---
/**
 * Optimized Image Component
 * Uses Astro's built-in image optimization for WebP/AVIF conversion
 *
 * Placeholder variants:
 * - "default": Icon + label on dashed border background (for asset planning)
 * - "fallback": Subtle failed-to-load style with just label text (for production placeholders)
 */
import { Image } from 'astro:assets';
import { getImage } from '@/lib/images';

interface Props {
  src?: string;
  alt: string;
  aspectRatio?: string;
  objectFit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';
  caption?: string;
  label?: string;
  placeholder?: 'default' | 'fallback';
  noMargin?: boolean;
  class?: string;
  style?: string;
  /** Image width for optimization (default: 1200) */
  width?: number;
  /** Image quality 1-100 (default: 80) */
  quality?: number;
}

const {
  src,
  alt,
  aspectRatio,
  objectFit = 'cover',
  caption,
  label,
  placeholder = 'default',
  noMargin = false,
  class: className = '',
  style: customStyle = '',
  width = 1200,
  quality = 80
} = Astro.props;

const isPlaceholder = !src;

// Check if it's an external URL
const isExternal = src?.startsWith('http://') || src?.startsWith('https://');

// Get optimized image from assets
let optimizedImage: ImageMetadata | undefined;
if (src && !isExternal) {
  // Convert /images/... path to images/... for lookup
  const imagePath = src.startsWith('/images/') ? src.replace('/images/', 'images/') : src;
  optimizedImage = getImage(imagePath);
}

// Build inline style for img container
const containerStyle = [
  aspectRatio ? `aspect-ratio: ${aspectRatio}` : '',
  customStyle
].filter(Boolean).join('; ');

const imgStyle = `object-fit: ${objectFit}`;
---

{isPlaceholder && placeholder === 'fallback' ? (
  <!-- Fallback placeholder: subtle failed-to-load style -->
  <div class:list={['placeholder-fallback', noMargin ? 'no-margin' : '', className]} style={containerStyle}>
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      <circle cx="8.5" cy="8.5" r="1.5"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
    {label && <span class="fallback-label">{label}</span>}
  </div>
) : isPlaceholder ? (
  <!-- Default placeholder: icon + label for asset planning -->
  <div class:list={['placeholder', noMargin ? 'no-margin' : '', className]} style={containerStyle}>
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
      <circle cx="8.5" cy="8.5" r="1.5"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
    {label && <span class="placeholder-label">{label}</span>}
  </div>
) : caption ? (
  <!-- With caption: wrap in figure -->
  <figure class:list={[noMargin ? 'figure-no-margin' : 'figure', className]} style={containerStyle}>
    {optimizedImage ? (
      <Image
        src={optimizedImage}
        alt={alt}
        width={width}
        quality={quality}
        format="webp"
        class="image"
        style={imgStyle}
      />
    ) : (
      <img src={src} alt={alt} loading="lazy" class="image" style={imgStyle} />
    )}
    <figcaption class="caption">{caption}</figcaption>
  </figure>
) : (
  <!-- Simple img -->
  <div class:list={['image-wrapper', noMargin ? 'no-margin' : '', className]} style={containerStyle}>
    {optimizedImage ? (
      <Image
        src={optimizedImage}
        alt={alt}
        width={width}
        quality={quality}
        format="webp"
        class="image"
        style={imgStyle}
      />
    ) : (
      <img src={src} alt={alt} loading="lazy" class="image" style={imgStyle} />
    )}
  </div>
)}

<style>
  .image-wrapper {
    overflow: hidden;
    border-radius: var(--radius-md);
  }

  .image {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius-md);
    margin: 0;
  }

  .figure {
    margin: var(--space-12) 0;
    display: flex;
    flex-direction: column;
  }

  @media (width >= 64rem) {
    .figure {
      margin: var(--space-16) 0;
    }
  }

  .figure > .image {
    flex: 1;
    min-height: 0;
  }

  .figure-no-margin {
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .figure-no-margin > .image {
    flex: 1;
    min-height: 0;
  }

  .caption {
    margin-top: var(--space-3);
    font-size: var(--font-caption, var(--text-sm));
    color: var(--color-text-secondary);
    text-align: center;
    font-style: italic;
  }

  .placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
    background-color: var(--color-bg-tertiary);
    border: 1px dashed var(--color-border-default);
    border-radius: var(--radius-md);
    min-height: 200px;
    margin: var(--space-12) 0;
    color: var(--color-text-tertiary);
  }

  @media (width >= 64rem) {
    .placeholder {
      margin: var(--space-16) 0;
    }
  }

  .placeholder svg {
    opacity: 0.5;
  }

  .placeholder-label {
    font-size: var(--font-caption, var(--text-sm));
    color: var(--color-text-secondary);
    text-align: center;
    padding: var(--space-4);
  }

  /* Fallback placeholder: subtle failed-to-load style */
  .placeholder-fallback {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    min-height: 80px;
    margin: var(--space-12) 0;
    padding: var(--space-4);
    color: var(--color-text-tertiary);
  }

  @media (width >= 64rem) {
    .placeholder-fallback {
      margin: var(--space-16) 0;
    }
  }

  .placeholder-fallback svg {
    opacity: 0.4;
    flex-shrink: 0;
  }

  .fallback-label {
    font-size: var(--font-caption, var(--text-sm));
    color: var(--color-text-tertiary);
    font-style: italic;
  }

  /* No margin override */
  .no-margin {
    margin: 0 !important;
  }
</style>
